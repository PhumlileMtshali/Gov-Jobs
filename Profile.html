<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile Section</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="style2.css">
</head>
<body>
<nav aria-label="Primary navigation">
  <div class="nav-inner">
    <a class="logo" href="#"><span class="seal">üèõÔ∏è</span> Gov Jobs SA</a>
    <div class="nav-links" id="navLinks">
      <a href="index.html" class="nav-link active">Home</a>
      <a href="jobs.html" class="nav-link active">Jobs</a>
      <a href="applications.html" class="nav-link active">Applications</a>
      <a href="Z83.html" class="nav-link active">Z83</a>
      <a href="about.html" class="nav-link active">About Us</a>
      <a href="contacts.html" class="nav-link active">Contact Us</a>
      
    </div>
    <div class="nav-actions">
      <a href="index.html" class="btn primary logout-btn">Log Out</a>

    </div>
  </div>
</nav>

<br>
<section class="profile-section container">
  <h2>Personal Details</h2>
  <form id="profileForm" class="profile-form" enctype="multipart/form-data">
    <div class="row">
      <div class="col-md-6 form-group">
        <label for="fullName">Full Name:</label>
        <input type="text" id="fullName" name="fullName" class="form-control" readonly>
      </div>
      <div class="col-md-6 form-group">
        <label for="dob">Date of Birth:</label>
        <input type="date" id="dob" name="dob" class="form-control" required>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 form-group">
        <label for="gender">Gender:</label>
        <select id="gender" name="gender" class="form-control" required>
          <option value="">-- Select --</option>
          <option value="female">Female</option>
          <option value="male">Male</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="col-md-6 form-group">
        <label for="race">Race:</label>
        <select id="race" name="race" class="form-control">
          <option value="">-- Select --</option>
          <option value="african">African</option>
          <option value="coloured">Coloured</option>
          <option value="indian">Indian</option>
          <option value="white">White</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="contactNumber">Contact Number:</label>
      <input type="tel" id="contactNumber" name="contactNumber" class="form-control" required>
    </div>

    <div class="form-group">
      <label for="email">Email Address:</label>
      <input type="email" id="email" name="email" class="form-control" readonly>
    </div>

    <div class="form-group">
      <label for="residentialAddress">Residential Address:</label>
      <textarea id="residentialAddress" name="residentialAddress" class="form-control" rows="3"></textarea>
    </div>

    <hr>
    <h2>Supporting Documents</h2>

    <div class="row">
      <div class="col-md-6 form-group">
        <label for="docType">Select Document Type:</label>
        <select id="docType" name="docType" class="form-control" required>
          <option value="">-- Select Document Type --</option>
          <option value="cv">CV / Resume</option>
          <option value="id">Identity Document</option>
          <option value="matric">Matric Certificate</option>
          <option value="qualifications">Qualifications</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="col-md-6 form-group">
        <label for="supportingDocs">Upload Document:</label>
        <input type="file" id="supportingDocs" name="supportingDocs" class="form-control">
        <small class="form-text text-muted">Allowed formats: PDF & DOCX</small>
      </div>
    </div>

    <div id="uploadedDocs" class="mt-3">
      <h5>Uploaded Documents:</h5>
      <ul class="list-group" id="docsList"></ul>
    </div>

    <div class="form-actions mt-4">
      <button type="submit" class="btn btn-success">Save Profile</button>
    </div>
  </form>
</section>

<footer class="footer mt-5" role="contentinfo">
  <div class="footer-bottom">
    &copy; 2025 Gov Jobs SA ‚Äî Empowering South African careers in public service.
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
<script>
  function getUserIdFromToken() {
    const token = localStorage.getItem("token");
    if (!token) return null;
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.id;
    } catch {
      return null;
    }
  }

  const userId = getUserIdFromToken();
  if (!userId) {
    alert("You must be logged in to access this page.");
    window.location.href = "index.html";
  }

  // Load profile & user info
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch(`http://localhost:5000/api/profile/${userId}`);
      if (res.ok) {
        const data = await res.json();
        document.getElementById("fullName").value = data.full_name || "";
        document.getElementById("dob").value = data.dob || "";
        document.getElementById("gender").value = data.gender || "";
        document.getElementById("race").value = data.race || "";
        document.getElementById("contactNumber").value = data.contact_number || "";
        document.getElementById("email").value = data.email || "";
        document.getElementById("residentialAddress").value = data.residential_address || "";

        // Show uploaded docs
        const docsList = document.getElementById("docsList");
        docsList.innerHTML = "";
        if (data.documents) {
          data.documents.forEach(doc => {
            const li = document.createElement("li");
            li.classList.add("list-group-item");
            li.textContent = `${doc.doc_type}: ${doc.file_name}`;
            docsList.appendChild(li);
          });
        }
      }
    } catch (err) {
      console.error("Error loading profile", err);
    }
  });

  // Save profile + upload document
  document.getElementById("profileForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const profileData = new FormData();
    profileData.append("userId", userId);
    profileData.append("id_number", document.getElementById("fullName").value); // optional if using separate ID
    profileData.append("dob", document.getElementById("dob").value);
    profileData.append("gender", document.getElementById("gender").value);
    profileData.append("race", document.getElementById("race").value);
    profileData.append("contact_number", document.getElementById("contactNumber").value);
    profileData.append("residential_address", document.getElementById("residentialAddress").value);

    const fileInput = document.getElementById("supportingDocs");
    if (fileInput.files.length > 0) {
      profileData.append("supportingDocs", fileInput.files[0]);
    }

    try {
      const res = await fetch("http://localhost:5000/api/profile", {
        method: "POST",
        body: profileData
      });
      if (res.ok) {
        alert("Profile saved successfully!");
        location.reload();
      } else {
        const err = await res.json();
        alert("Error saving profile: " + (err.error || "Unknown error"));
      }
    } catch (err) {
      console.error("Error saving profile", err);
      alert("Error connecting to server");
    }
  });
</script>
<script src="logout.js"></script>
</body>
</html>
