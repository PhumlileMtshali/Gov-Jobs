<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jobs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style2.css">
</head>
<body>
<!-- NAV -->
<nav aria-label="Primary navigation">
  <div class="nav-inner">
    <a class="logo" href="#"><span class="seal">üèõÔ∏è</span> <span>Gov Jobs SA</span></a>
    <div class="nav-links" id="navLinks">
      <a href="index.html" class="nav-link active">Home</a>
      <a href="applications.html" class="nav-link active">Applications</a>
      <a href="Z83.html" class="nav-link active">Z83</a>
      <a href="contacts.html" class="nav-link active">Contact Us</a>
      <a href="faq.html" class="nav-link active">FAQs</a>
      <a href="notifications.html" class="nav-link active">Notifications</a>
    </div>

    <!-- üîî Notification Bell -->
    <div class="dropdown me-3">
      <button class="btn btn-light position-relative" id="notifBell" data-bs-toggle="dropdown">
        üîî
        <span id="notifCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end" id="notifList">
        <li><span class="dropdown-item-text">No new notifications</span></li>
      </ul>
    </div>

    <div class="nav-actions">
      <a href="index.html" class="btn primary logout-btn">Log Out</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h2 class="mb-3">Available Jobs</h2>
  <div id="jobsList" class="row"></div>
</div>

<footer class="footer mt-5">
  <div class="text-center">&copy; 2025 Gov Jobs SA</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function getUserIdFromToken() {
    const token = localStorage.getItem("token");
    if (!token) return null;
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.id;
    } catch {
      return null;
    }
  }

  const userId = getUserIdFromToken();
  if (!userId) {
    alert("You must be logged in to view jobs.");
    window.location.href = "index.html";
  }

  async function loadJobs() {
    try {
      const res = await fetch("http://localhost:5000/api/jobs");
      const jobs = await res.json();

      const jobsList = document.getElementById("jobsList");
      jobsList.innerHTML = "";

      if (jobs.length === 0) {
        jobsList.innerHTML = "<p>No jobs available right now.</p>";
        return;
      }

      jobs.forEach(job => {
        const col = document.createElement("div");
        col.classList.add("col-md-4", "mb-3");

        col.innerHTML = `
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">${job.title}</h5>
              <p class="card-text">
                <strong>Department:</strong> ${job.department || "N/A"}<br>
                <strong>Location:</strong> ${job.location || "N/A"}
              </p>
              <button class="btn btn-primary apply-btn" data-job-id="${job.id}">Apply</button>
            </div>
          </div>
        `;

        jobsList.appendChild(col);
      });
    } catch (err) {
      console.error("Error loading jobs:", err);
      alert("Error loading jobs");
    }
  }

  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("apply-btn")) {
      const jobId = e.target.getAttribute("data-job-id");

      try {
        const res = await fetch("http://localhost:5000/api/applications", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, job_id: jobId }) // ‚úÖ fixed keys
        });

        const data = await res.json();

        if (res.ok) {
          alert("‚úÖ Application submitted successfully!");
          loadNotifications();
        } else {
          alert("‚ö†Ô∏è Error: " + data.error);
        }
      } catch (err) {
        console.error("Error applying:", err);
        alert("Server error while applying.");
      }
    }
  });

  async function loadNotifications() {
    try {
      const res = await fetch(`http://localhost:5000/api/notifications/${userId}`);
      const notifs = await res.json();

      const notifCount = document.getElementById("notifCount");
      const notifList = document.getElementById("notifList");

      notifList.innerHTML = "";

      if (notifs.length === 0) {
        notifList.innerHTML = "<li><span class='dropdown-item-text'>No new notifications</span></li>";
        notifCount.textContent = "0";
        return;
      }

      const unread = notifs.filter(n => !n.is_read);
      notifCount.textContent = unread.length;

      notifs.forEach(n => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="dropdown-item-text">${n.message}</span>`;
        notifList.appendChild(li);
      });
    } catch (err) {
      console.error("Error fetching notifications:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadJobs();
    loadNotifications();
  });

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("logout-btn")) {
      e.preventDefault();
      if (confirm("Are you sure you want to log out?")) {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }
    }
  });
</script>
</body>
</html>
